# Цифровая викторина  
**Проект бота для новогодней викторины.**

# Процесс  
___Чтобы отвечать на вопросы викторины, сначала необходимо найти какой-то QR код, таким образом разблокировав вопрос.___
* В начале взаимодействия пользователю необходимо авторизовать устройство, перейдя по предлагаемой ботом ссылке. 
Сервер запишет куки, по которым в дальнейшем сможет соотносить браузер пользователя и его аккаунт ВК.  
* В процессе викторины игрок ищет и сканирует QR коды, ссылка ведет на сервер. 
Там пользователя идентифицируют по ранее полученной куке, бот отправляет ему очередной вопрос викторины, связанный с конкретным кодом.  
* В случае, если пользователь отвечает правильно, он получает балл. Один код - одна попытка.  

# Что использовано
## API
* [VK Callback API](https://vk.com/dev/callback_api)  
## Сервер
* [pythonanywhere.com](https://pythonanywhere.com)  
## Библиотеки
* [vk_api](https://vk-api.readthedocs.io/en/latest/)  
* [Flask](https://flask.palletsprojects.com/en/1.1.x/)

# Сценарий  
Общение с ботом - это какой-то сценарий. И у этого сценария есть несколько стадий.
### 1 - Приветствие (`GREET`)
На этом этапе бот реагирует на любое сообщение, в ответ приветствует и отправляет краткие правила. Стадия сразу переключается на следующую.  
### 2 - Главная (`MAIN`)  
На этой стадии у пользователя появляется клавиатура со следующими кнопками-командами:  
* **Привязать устройство**  
* **Отвязать устройство**  
* **Статистика** - количество найденных кодов, количество полученных баллов  
* **Помощь** - подробное описание процесса  
* **Связь** - отправляет администратору уведомление о том, что пользователю нужна помощь. 
В ВК уже реализована возможность работы с сообщениями группы даже из мобильного приложения, так что я не стал прорабатывать функцию связи детальнее.  
### 3 - Вопрос (`ASKED`)  
Переход в эту стадию осуществляется, когда пользователь переходит по ссылке из QR. 
Тут бот задаёт вопрос и ждёт ответа, далее проверяет его и отправляет пользователя либо на вторую стадию, либо на **четвёртую**  
### 4 - Конец игры (`FINISHED`)  
Все вопросы заданы, баллы заработаны, остаётся только ждать результатов. На клавиатуре единственная кнопка - **Связь**  

# Техническая реализация  

## [main.py](main.py)
Flask-сервер. В функции, на route которой VK Callback API непосредственно отправляет запросы, проверяется тип события.  
* `confirmation`  
Добавление сервера в настройках группы. Возвращает заранее определенный `confirmation_code`
* `message_new`  
Новое сообщение в лс группы. Вызывается функция `bot.handle_new_message(data['object'], vk)`, 
где `data` - содержимое POST-запроса, `vk` - авторизованный объект api из библиотеки **vk_api**

## [bot.py](bot.py)  
Мастер-обработчик. В методе `handle_new_message` подбирается соответствующий стадии диалога и сообщению обработчик, в него передаются:  
* `obj` - объект события  
* `api` - объект api   
* `user` - экзмемпляр класса `json_storage.User`  

## [json_storage.py](json_storage.py)  
Простое NO-SQL хранилище, основанное на хранении словарей **ключ: значение** в формате `.json`. В файле - два класса.  

### JsonStorage  
Сам класс хранилища. Создаёт директорию, файлы под каждого пользователя, получает и обновляет данные в `.json` файлах.  
### User  
Класс, созданный для удобства взаимодействия с `JsonStorage`. Инициализируется по vk_id.  
```
user = User(123)

# get smth
smth = user["some_key"]

# put new data
user["another_key"] = smth + 1

# update existing value
user["some_key"] = "new value"

# get exisiting keys
keys = user.get_keys()
```

## [conversation_config.py](conversation_config.py)  
В этом файле создаётся JsonStorage и объект сценария - словарь формата  
```
{
  state0: [
    ('filter-0', handler0),
    ('filter-1', handler1),
    ...
  ],
  state1: ...
}
```
Где `state` - код стадии, `handler` - обработчик события, `filter` - regex выражение, так называемый фильтр.  

### Как это работает:  
Когда в [bot.handle_new_message](#botpy) необходимо найти соответствующий обработчик, 
в цикле перебираются все доступные для стадии, на которой находится пользователь.  
Если текст сообщения полностью подходит регулярному выражению-фильтру, то обработчик найден.  
Вызывается `handler(obj, api, user)`, и если он возвращает код стадии сценария, то она обновляется для текущего пользователя.

## [states.py](states.py)  
Здесь находятся константы кодов стадий: `GREET, MAIN, ASKED, FINISHED`  

## [functions.py](functions.py)  
Все обработчики сценария + некоторые вспомогательные функции

## [qr.py](qr.py)  
Класс для работы с QR кодами и вопросами  

## [accounts.py](accounts.py)  
Класс для работы с авторизацией пользователей  



